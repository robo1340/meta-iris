//standard includes
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <assert.h>
#include <time.h>

#include <czmq.h>

#include "print_util.h"

#include "slip.h"

typedef struct test_vector_DEF {
	uint8_t * slip_buf;
	size_t slip_buf_len;
	uint8_t * packet_expected;
	size_t expected_packet_len;
}test_vector_t;

static uint8_t test_in_1[] = {0xc0, 0x00, 0x01, 0x02, 0xc0};
static uint8_t test_out_1[] = {0x00, 0x01, 0x02};
static uint8_t test_in_2[] = {0xc0, 0xdb, 0xdc, 0xdb, 0xdd, 0xc0};
static uint8_t test_out_2[] = {0xc0, 0xdb};

static uint8_t test_buf[] = {0xc0,0x45,0x00,0x00,0x2e,0x29,0x1d,0x40,0x00,0x40,0x11,0xf7,0xc3,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0x98,0xe3,0x13,0x8d,0x00,0x1a,0x95,0xea,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x36,0x33,0x33,0x31,0xc0};
static uint8_t test_buf_out[] = {0x45,0x00,0x00,0x2e,0x29,0x1d,0x40,0x00,0x40,0x11,0xf7,0xc3,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0x98,0xe3,0x13,0x8d,0x00,0x1a,0x95,0xea,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x36,0x33,0x33,0x31};

static uint8_t test_buf_long[] = {0xc0,0x45,0x00,0x01,0xf4,0x0f,0xdb,0xdc,0x20,0x00,0x40,0x11,0x2f,0x5b,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0xdc,0x07,0x13,0x8d,0x07,0x10,0x16,0x19,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0xc0,0xc0,0x45,0x00,0x01,0xf4,0x0f,0xdb,0xdc,0x20,0x3c,0x40,0x11,0x2f,0x1f,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0xc0,0xc0,0x45,0x00,0x01,0xf4,0x0f,0xdb,0xdc,0x20,0x78,0x40,0x11,0x2e,0xe3,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0xc0,0xc0,0x45,0x00,0x01,0x84,0x0f,0xdb,0xdc,0x00,0xb4,0x40,0x11,0x4f,0x17,0x0a,0xf2,0x01,0xfd,0x0a,0xf2,0x01,0xfe,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0x6d,0x65,0x73,0x73,0x61,0x67,0x65,0x3a,0x31,0x37,0x30,0x36,0x31,0x34,0x37,0x32,0x37,0x32,0xc0};

test_vector_t tvs[] = {
	{test_in_1, 	sizeof(test_in_1), 		test_out_1, sizeof(test_out_1)},
	{test_in_2, 	sizeof(test_in_2), 		test_out_2, sizeof(test_out_2)},
	{test_buf, 		sizeof(test_buf),	   	test_buf_out, sizeof(test_buf_out)},
	{test_buf_long, sizeof(test_buf_long), 	NULL, 0},
};

static void run_test(test_vector_t * tv){
	static int steps[] = {1,2,3,10,100};
	//static int steps[] = {1};
	int i;
	
	for (i=0; i<sizeof(steps)/sizeof(steps[0]); i++){
		printf("run_test(len=%u,step=%d)\n", tv->slip_buf_len, steps[i]);
		if (steps[i] > tv->slip_buf_len){break;}
		
		uint8_t * ptr = tv->slip_buf;
		bool stopped = false;
		int feed_len;
		int step = steps[i];
		zchunk_t * packet = NULL;
		
		#define remaining (tv->slip_buf_len-(ptr-tv->slip_buf))
		while(!stopped){
			stopped = (remaining < step);
			feed_len = (!stopped) ? step : remaining;
			
			packet = slip_decoder_feed(ptr, feed_len);
			ptr+=feed_len;
			
			if (packet != NULL){
				printf("Packet Decoded Len: %u\n", zchunk_size(packet));
				printArrHex(zchunk_data(packet), zchunk_size(packet));
				if (tv->packet_expected != NULL){
					assert(tv->expected_packet_len==zchunk_size(packet));
					assert(memcmp(tv->packet_expected, zchunk_data(packet), tv->expected_packet_len)==0);
				}
				zchunk_destroy(&packet);
			}
		}
	}
}


int main(void) {
	int i;
	
	for (i=0; i<sizeof(tvs)/sizeof(test_vector_t); i++){
		run_test(&tvs[i]);	
	}
	
	printf("Test passed!\n");
}
